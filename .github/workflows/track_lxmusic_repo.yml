name: Track wzh15802/lxmusic Repository

on:
  schedule:
    # 每周检查一次更新 (每周日凌晨2点)
    - cron: '0 2 * * 0'
  workflow_dispatch: # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        path: main-repo
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check for wzh15802/lxmusic repository updates
      id: check_updates
      run: |
        # 检查wzh15802/lxmusic仓库的最新提交
        git clone --depth 1 https://github.com/wzh15802/lxmusic.git lxmusic-repo
        cd lxmusic-repo
        LATEST_COMMIT=$(git rev-parse HEAD)
        echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
        
        # 检查最近的提交信息
        COMMIT_MESSAGE=$(git log -1 --pretty=format:%s)
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        
        # 获取仓库的更新日期
        UPDATE_DATE=$(git log -1 --format=%cd)
        echo "update_date=$UPDATE_DATE" >> $GITHUB_OUTPUT
        
        # 检查是否有更新
        cd ../main-repo
        if [ -f "entertainment/lxmusic-api/lxmusic-last-commit.txt" ]; then
          PREVIOUS_COMMIT=$(cat entertainment/lxmusic-api/lxmusic-last-commit.txt)
          if [ "$PREVIOUS_COMMIT" = "$LATEST_COMMIT" ]; then
            echo "Repository has not changed, exiting"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        echo "has_changes=true" >> $GITHUB_OUTPUT
        echo "New changes detected in wzh15802/lxmusic repository"
    
    - name: Setup Git configuration
      if: steps.check_updates.outputs.has_changes == 'true'
      run: |
        cd main-repo
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Update wzh15802/lxmusic commit reference and API info
      if: steps.check_updates.outputs.has_changes == 'true'
      run: |
        cd main-repo
        # 创建目录（如果不存在）
        mkdir -p entertainment/lxmusic-api
        
        # 更新提交记录
        echo "${{ steps.check_updates.outputs.latest_commit }}" > entertainment/lxmusic-api/lxmusic-last-commit.txt
        git add entertainment/lxmusic-api/lxmusic-last-commit.txt
        
        # 更新变更日志
        cat > entertainment/lxmusic-api/CHANGES_LOG.md << 'EOF'
# wzh15802/lxmusic Repository Changes Log

## Latest Update
- **Latest Commit**: ${{ steps.check_updates.outputs.latest_commit }}
- **Commit Message**: ${{ steps.check_updates.outputs.commit_message }}
- **Update Date**: ${{ steps.check_updates.outputs.update_date }}
- **Tracked Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

## Notes
This file tracks changes in the wzh15802/lxmusic repository.
EOF
        git add entertainment/lxmusic-api/CHANGES_LOG.md
        
        # 提交更改
        git commit -m "feat(lxmusic): Track latest changes from wzh15802/lxmusic repository\n\nLatest commit: ${{ steps.check_updates.outputs.latest_commit }}\nCommit message: ${{ steps.check_updates.outputs.commit_message }}\n\nUpdated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        git push
        
        echo "Changes committed and pushed"

    - name: Update wzh15802/lxmusic API documentation
      if: steps.check_updates.outputs.has_changes == 'true'
      run: |
        cd main-repo
        # 创建目录（如果不存在）- 确保目录存在
        mkdir -p entertainment/lxmusic-api
        
        # 更新API文档
        cat > entertainment/lxmusic-api/README.md << 'EOF'
# wzh15802/lxmusic API Documentation

This directory contains documentation and information about the wzh15802/lxmusic API that our application uses.

## API Endpoints

The following endpoints are available in wzh15802/lxmusic desktop application when the Open API feature is enabled:

### Get Player Status
- **Endpoint**: `/status`
- **Method**: GET
- **Description**: Returns the current player status
- **Response**: JSON object with status, name, singer, albumName, duration, progress, etc.

### Get Current Lyrics
- **Endpoint**: `/lyric`
- **Method**: GET
- **Description**: Returns the current LRC lyrics as text

### Get All Lyrics Types
- **Endpoint**: `/lyric-all`
- **Method**: GET
- **Description**: Returns all types of lyrics (original, translation, romanization)

### Player Control Endpoints
- **Play**: `/play` (POST)
- **Pause**: `/pause` (POST)
- **Next Track**: `/skip-next` (POST)
- **Previous Track**: `/skip-prev` (POST)
- **Seek Position**: `/seek` (POST) with offset parameter
- **Volume Control**: `/volume` (POST) with volume parameter (1-100)
- **Mute Control**: `/mute` (POST) with mute parameter (true/false)

### Player Status Subscription (SSE)
- **Endpoint**: `/subscribe-player-status`
- **Method**: GET
- **Description**: Server-Sent Events stream for real-time status updates

## Default API URL
- **Default URL**: http://127.0.0.1:23330

## How to Enable
To use these APIs, you need to enable the Open API feature in wzh15802/lxmusic desktop application:
1. Open wzh15802/lxmusic desktop application
2. Go to Settings
3. Enable "Open API" feature
4. Note the API port (default is 23330)

## Usage in Our Application
Our application uses these endpoints to:
- Get current playing track information
- Control playback (play, pause, next, previous)
- Get audio spectrum data for visualization (if available)
- Subscribe to real-time player status updates
EOF
        git add entertainment/lxmusic-api/README.md
        
        # 提交所有更改
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git commit -m "docs(lxmusic-api): Update wzh15802/lxmusic API documentation\n\nUpdated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n\nTracked from wzh15802/lxmusic repository"
        git push
        echo "Changes committed and pushed"