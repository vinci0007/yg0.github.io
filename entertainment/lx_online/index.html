<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LX Music åœ¨çº¿ç‰ˆ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>LX Music åœ¨çº¿ç‰ˆ</h1>
            <p class="subtitle">åŸºäº lx-music-desktop çš„åœ¨çº¿éŸ³ä¹æ’­æ”¾å™¨</p>
        </header>

        <!-- å·¦ä¾§ï¼šéŸ³æºç®¡ç† -->
        <div class="source-manager">
            <h2 class="section-title">éŸ³æºç®¡ç†</h2>
            <button class="scan-btn" id="scanSourcesBtn">æ‰«æéŸ³æº</button>
            <div class="source-selector">
                <div class="source-option active" data-source="kw">é…·æˆ‘éŸ³ä¹</div>
                <div class="source-option" data-source="kg">é…·ç‹—éŸ³ä¹</div>
                <div class="source-option" data-source="tx">QQéŸ³ä¹</div>
                <div class="source-option" data-source="wy">ç½‘æ˜“äº‘éŸ³ä¹</div>
                <div class="source-option" data-source="mg">å’ªå’•éŸ³ä¹</div>
            </div>
            <ul class="source-list" id="sourceList">
                <li class="loading">ç‚¹å‡»"æ‰«æéŸ³æº"æŒ‰é’®è·å–éŸ³æºåˆ—è¡¨</li>
            </ul>
        </div>

        <!-- ä¸­é—´ï¼šæœç´¢å’Œæ’­æ”¾å™¨ -->
        <div class="main-content">
            <div class="search-section">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ­Œæ›²ã€æ­Œæ‰‹æˆ–ä¸“è¾‘...">
                    <button class="search-btn" id="searchBtn">æœç´¢</button>
                </div>
                <div class="source-selector">
                    <div class="source-option active" data-source="kw">é…·æˆ‘</div>
                    <div class="source-option" data-source="kg">é…·ç‹—</div>
                    <div class="source-option" data-source="tx">QQéŸ³ä¹</div>
                    <div class="source-option" data-source="wy">ç½‘æ˜“äº‘</div>
                    <div class="source-option" data-source="mg">å’ªå’•</div>
                </div>
            </div>

            <div class="player-section">
                <div class="track-info">
                    <div class="album-art">ğŸµ</div>
                    <div class="track-details">
                        <div class="track-title" id="currentTitle">æš‚æ— æ­Œæ›²</div>
                        <div class="track-artist" id="currentArtist">-</div>
                        <div class="track-album" id="currentAlbum">-</div>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" id="progressBarContainer">
                        <div class="progress" id="progressBar"></div>
                    </div>
                    <div class="time-info">
                        <span id="currentTime">00:00</span>
                        <span id="totalTime">00:00</span>
                    </div>
                </div>

                <div class="controls">
                    <button class="control-btn" id="prevBtn">â®</button>
                    <button class="control-btn play-pause" id="playBtn">â–¶</button>
                    <button class="control-btn" id="nextBtn">â­</button>
                    <button class="control-btn" id="likeBtn">â¤</button>
                    <button class="control-btn" id="volumeBtn">ğŸ”Š</button>
                </div>
            </div>

            <div class="results-section">
                <h2 class="section-title">æœç´¢ç»“æœ</h2>
                <ul class="search-results" id="searchResults">
                    <li class="loading">è¯·è¾“å…¥å…³é”®è¯æœç´¢éŸ³ä¹</li>
                </ul>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ’­æ”¾åˆ—è¡¨ -->
        <div class="playlist-section">
            <h2 class="section-title">æ’­æ”¾åˆ—è¡¨</h2>
            <div class="playlist-controls">
                <button class="playlist-btn active" id="currentPlaylistBtn">å½“å‰åˆ—è¡¨</button>
                <button class="playlist-btn" id="createPlaylistBtn">åˆ›å»ºåˆ—è¡¨</button>
            </div>
            <ul class="playlist" id="playlist">
                <li class="loading">æ’­æ”¾åˆ—è¡¨ä¸ºç©º</li>
            </ul>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script src="/entertainment/lxmusic-api/api.js"></script>
    <script src="sourceManager.js"></script>
    <script>
        // éŸ³ä¹æ’­æ”¾å™¨ç±»
        class MusicPlayer {
            constructor() {
                this.currentTrack = null;
                this.isPlaying = false;
                this.currentPlaylist = [];
                this.playlists = {
                    current: []
                };
                this.currentSource = 'kw';
                this.audio = document.getElementById('audioPlayer');
                this.audio.volume = 0.7; // é»˜è®¤éŸ³é‡70%
                this.sourceManager = new SourceManager();
                
                this.initEventListeners();
                this.loadDemoPlaylist();
            }
            
            initEventListeners() {
                // æ’­æ”¾/æš‚åœæŒ‰é’®
                document.getElementById('playBtn').addEventListener('click', () => this.togglePlay());
                
                // ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–
                document.getElementById('prevBtn').addEventListener('click', () => this.playPrev());
                document.getElementById('nextBtn').addEventListener('click', () => this.playNext());
                
                // æœç´¢åŠŸèƒ½
                document.getElementById('searchBtn').addEventListener('click', () => this.performSearch());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.performSearch();
                });
                
                // è¿›åº¦æ¡æ‹–æ‹½
                const progressBarContainer = document.getElementById('progressBarContainer');
                progressBarContainer.addEventListener('click', (e) => {
                    const rect = progressBarContainer.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    this.audio.currentTime = pos * this.audio.duration;
                });
                
                // éŸ³é‡æ§åˆ¶
                document.getElementById('volumeBtn').addEventListener('click', () => {
                    this.audio.muted = !this.audio.muted;
                    document.getElementById('volumeBtn').textContent = this.audio.muted ? 'ğŸ”‡' : 'ğŸ”Š';
                });
                
                // éŸ³æºé€‰æ‹©
                document.querySelectorAll('.source-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.source-option').forEach(o => o.classList.remove('active'));
                        option.classList.add('active');
                        this.currentSource = option.dataset.source;
                    });
                });
                
                // æ‰«æéŸ³æºæŒ‰é’®
                document.getElementById('scanSourcesBtn').addEventListener('click', () => {
                    this.scanAndRenderSources();
                });
                
                // æ’­æ”¾åˆ—è¡¨åˆ‡æ¢
                document.getElementById('currentPlaylistBtn').addEventListener('click', () => {
                    document.querySelectorAll('.playlist-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('currentPlaylistBtn').classList.add('active');
                    this.renderPlaylist();
                });
                
                document.getElementById('createPlaylistBtn').addEventListener('click', () => {
                    document.querySelectorAll('.playlist-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('createPlaylistBtn').classList.add('active');
                    this.showCreatePlaylist();
                });
                
                // éŸ³é¢‘äº‹ä»¶ç›‘å¬
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('ended', () => this.playNext());
                this.audio.addEventListener('loadedmetadata', () => {
                    document.getElementById('totalTime').textContent = this.formatTime(this.audio.duration);
                });
            }
            
            // æ‰«æå¹¶æ¸²æŸ“éŸ³æºåˆ—è¡¨
            async scanAndRenderSources() {
                const scanBtn = document.getElementById('scanSourcesBtn');
                scanBtn.disabled = true;
                scanBtn.textContent = 'æ‰«æä¸­...';
                
                try {
                    const sources = await this.sourceManager.scanSources();
                    this.renderSources(sources);
                } catch (error) {
                    console.error('æ‰«æéŸ³æºå¤±è´¥:', error);
                    alert('æ‰«æéŸ³æºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦æƒ…');
                } finally {
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'é‡æ–°æ‰«æéŸ³æº';
                }
            }
            
            // æ¸²æŸ“éŸ³æºåˆ—è¡¨
            renderSources(sources) {
                const sourceList = document.getElementById('sourceList');
                
                if (sources.length === 0) {
                    sourceList.innerHTML = '<li class="loading">æœªæ‰¾åˆ°éŸ³æºæ–‡ä»¶</li>';
                    return;
                }
                
                sourceList.innerHTML = '';
                
                sources.forEach(source => {
                    const li = document.createElement('li');
                    li.className = 'source-item';
                    li.innerHTML = `
                        <div class="source-info">
                            <div class="source-name">${source.name}</div>
                            <div class="source-desc">${source.description}</div>
                            <div class="source-version">ç‰ˆæœ¬: ${source.version}</div>
                        </div>
                        <div class="source-toggle" 
                             data-source-id="${source.id}"></div>
                    `;
                    
                    // æ·»åŠ åˆ‡æ¢äº‹ä»¶
                    const toggle = li.querySelector('.source-toggle');
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                        if (toggle.classList.contains('active')) {
                            this.sourceManager.enableSource(source.id);
                        } else {
                            this.sourceManager.disableSource(source.id);
                        }
                    });
                    
                    sourceList.appendChild(li);
                });
            }
            
            // åŠ è½½æ¼”ç¤ºæ’­æ”¾åˆ—è¡¨
            loadDemoPlaylist() {
                // è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”ç”¨ä¸­åº”ä»APIè·å–
                this.playlists.current = [
                    {
                        id: '1',
                        title: 'å¤œæ›²',
                        artist: 'å‘¨æ°ä¼¦',
                        album: 'åä¸€æœˆçš„è§é‚¦',
                        duration: 218,
                        source: 'ç½‘æ˜“äº‘',
                        url: 'https://music.163.com/song/media/outer/url?id=22705034.mp3' // ç¤ºä¾‹é“¾æ¥
                    },
                    {
                        id: '2',
                        title: 'é’èŠ±ç“·',
                        artist: 'å‘¨æ°ä¼¦',
                        album: 'æˆ‘å¾ˆå¿™',
                        duration: 265,
                        source: 'QQéŸ³ä¹',
                        url: 'https://music.163.com/song/media/outer/url?id=22705035.mp3' // ç¤ºä¾‹é“¾æ¥
                    },
                    {
                        id: '3',
                        title: 'ç¨»é¦™',
                        artist: 'å‘¨æ°ä¼¦',
                        album: 'é­”æ°åº§',
                        duration: 295,
                        source: 'é…·ç‹—',
                        url: 'https://music.163.com/song/media/outer/url?id=22705036.mp3' // ç¤ºä¾‹é“¾æ¥
                    },
                    {
                        id: '4',
                        title: 'ä¸ƒé‡Œé¦™',
                        artist: 'å‘¨æ°ä¼¦',
                        album: 'ä¸ƒé‡Œé¦™',
                        duration: 282,
                        source: 'å’ªå’•',
                        url: 'https://music.163.com/song/media/outer/url?id=22705037.mp3' // ç¤ºä¾‹é“¾æ¥
                    },
                    {
                        id: '5',
                        title: 'å‘Šç™½æ°”çƒ',
                        artist: 'å‘¨æ°ä¼¦',
                        album: 'å‘¨æ°ä¼¦çš„åºŠè¾¹æ•…äº‹',
                        duration: 201,
                        source: 'é…·æˆ‘',
                        url: 'https://music.163.com/song/media/outer/url?id=22705038.mp3' // ç¤ºä¾‹é“¾æ¥
                    }
                ];
                
                this.renderPlaylist();
            }
            
            // æ˜¾ç¤ºåˆ›å»ºæ’­æ”¾åˆ—è¡¨ç•Œé¢
            showCreatePlaylist() {
                // åˆ›å»ºè¾“å…¥æ¡†å’ŒæŒ‰é’®
                const playlistEl = document.getElementById('playlist');
                playlistEl.innerHTML = `
                    <li>
                        <input type="text" id="newPlaylistName" placeholder="è¾“å…¥æ’­æ”¾åˆ—è¡¨åç§°" style="width: 100%; padding: 8px; margin-bottom: 10px; background: rgba(0,0,0,0.3); border: 1px solid #4d9eff; border-radius: 4px; color: white;">
                        <button id="savePlaylistBtn" style="width: 100%; padding: 10px; background: #4d9eff; border: none; border-radius: 4px; color: white; cursor: pointer;">åˆ›å»ºæ’­æ”¾åˆ—è¡¨</button>
                    </li>
                `;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('savePlaylistBtn').addEventListener('click', () => {
                    const name = document.getElementById('newPlaylistName').value.trim();
                    if (name) {
                        this.createPlaylist(name);
                    }
                });
            }
            
            // åˆ›å»ºæ–°æ’­æ”¾åˆ—è¡¨
            createPlaylist(name) {
                if (!name) return;
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ’­æ”¾åˆ—è¡¨
                if (this.playlists[name]) {
                    alert('æ’­æ”¾åˆ—è¡¨å·²å­˜åœ¨ï¼');
                    return;
                }
                
                this.playlists[name] = [];
                
                // åˆ‡æ¢å›å½“å‰æ’­æ”¾åˆ—è¡¨è§†å›¾
                document.querySelectorAll('.playlist-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('currentPlaylistBtn').classList.add('active');
                this.renderPlaylist();
            }
            
            // æ’­æ”¾æŒ‡å®šæ­Œæ›²
            async playTrack(track) {
                // å¦‚æœtrackæ²¡æœ‰urlå±æ€§ï¼Œå°è¯•ä»APIè·å–
                if (!track.url) {
                    const musicUrl = await this.sourceManager.getMusicUrl(track);
                    if (musicUrl) {
                        this.currentTrack = {...track, url: musicUrl};
                    } else {
                        console.error('æ— æ³•è·å–éŸ³ä¹æ’­æ”¾åœ°å€');
                        alert(`æ— æ³•æ’­æ”¾ "${track.title}"ï¼Œè¯·å°è¯•å…¶ä»–æ­Œæ›²`);
                        return;
                    }
                } else {
                    this.currentTrack = track;
                }
                
                this.audio.src = this.currentTrack.url;
                
                // æ›´æ–°ç•Œé¢
                document.getElementById('currentTitle').textContent = this.currentTrack.title;
                document.getElementById('currentArtist').textContent = this.currentTrack.artist;
                document.getElementById('currentAlbum').textContent = this.currentTrack.album;
                
                // æ›´æ–°æ’­æ”¾åˆ—è¡¨æ˜¾ç¤º
                this.renderPlaylist();
                
                // æ’­æ”¾
                this.audio.play()
                    .then(() => {
                        this.isPlaying = true;
                        document.getElementById('playBtn').textContent = 'â¸';
                    })
                    .catch(e => {
                        console.error('æ’­æ”¾å¤±è´¥:', e);
                        // å°è¯•ä½¿ç”¨å¤‡ç”¨é“¾æ¥
                        this.tryBackupSource(this.currentTrack);
                    });
            }
            
            // å°è¯•å¤‡ç”¨éŸ³æº
            tryBackupSource(track) {
                // è¿™é‡Œå¯ä»¥å°è¯•ä½¿ç”¨å…¶ä»–éŸ³æºAPIè·å–æ’­æ”¾é“¾æ¥
                console.log(`å°è¯•ä½¿ç”¨å¤‡ç”¨éŸ³æºè·å– ${track.title} çš„æ’­æ”¾é“¾æ¥`);
                
                // æ¨¡æ‹Ÿè·å–å¤‡ç”¨é“¾æ¥
                const backupUrl = `https://music.163.com/song/media/outer/url?id=${track.id.split('_').pop() || '22705034'}.mp3`;
                this.audio.src = backupUrl;
                
                this.audio.play()
                    .then(() => {
                        this.isPlaying = true;
                        document.getElementById('playBtn').textContent = 'â¸';
                    })
                    .catch(e => {
                        console.error('å¤‡ç”¨éŸ³æºæ’­æ”¾å¤±è´¥:', e);
                        alert(`æ— æ³•æ’­æ”¾ "${track.title}"ï¼Œè¯·å°è¯•å…¶ä»–æ­Œæ›²`);
                    });
            }
            
            // æ’­æ”¾/æš‚åœåˆ‡æ¢
            togglePlay() {
                if (!this.currentTrack) {
                    if (this.playlists.current.length > 0) {
                        this.playTrack(this.playlists.current[0]);
                    }
                    return;
                }
                
                if (this.isPlaying) {
                    this.audio.pause();
                    this.isPlaying = false;
                    document.getElementById('playBtn').textContent = 'â–¶';
                } else {
                    this.audio.play()
                        .then(() => {
                            this.isPlaying = true;
                            document.getElementById('playBtn').textContent = 'â¸';
                        })
                        .catch(e => {
                            console.error('æ’­æ”¾å¤±è´¥:', e);
                        });
                }
            }
            
            // æ’­æ”¾ä¸‹ä¸€é¦–
            playNext() {
                if (this.playlists.current.length === 0) return;
                
                const currentIndex = this.playlists.current.findIndex(track => track.id === this.currentTrack?.id);
                const nextIndex = (currentIndex + 1) % this.playlists.current.length;
                this.playTrack(this.playlists.current[nextIndex]);
            }
            
            // æ’­æ”¾ä¸Šä¸€é¦–
            playPrev() {
                if (this.playlists.current.length === 0) return;
                
                const currentIndex = this.playlists.current.findIndex(track => track.id === this.currentTrack?.id);
                const prevIndex = (currentIndex - 1 + this.playlists.current.length) % this.playlists.current.length;
                this.playTrack(this.playlists.current[prevIndex]);
            }
            
            // æ›´æ–°æ’­æ”¾è¿›åº¦
            updateProgress() {
                if (this.audio.duration) {
                    const progress = (this.audio.currentTime / this.audio.duration) * 100;
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('currentTime').textContent = this.formatTime(this.audio.currentTime);
                }
            }
            
            // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬åˆ†:ç§’ï¼‰
            formatTime(seconds) {
                if (isNaN(seconds)) return '00:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
            renderPlaylist() {
                const playlistEl = document.getElementById('playlist');
                
                // è·å–å½“å‰é€‰ä¸­çš„æ’­æ”¾åˆ—è¡¨
                let tracks = this.playlists.current;
                
                if (document.getElementById('currentPlaylistBtn').classList.contains('active')) {
                    tracks = this.playlists.current;
                } else {
                    // å¦‚æœæ˜¾ç¤ºå…¶ä»–æ’­æ”¾åˆ—è¡¨ï¼Œè¿™é‡Œå¯ä»¥æ‰©å±•
                    tracks = this.playlists.current;
                }
                
                if (tracks.length === 0) {
                    playlistEl.innerHTML = '<li class="loading">æ’­æ”¾åˆ—è¡¨ä¸ºç©º</li>';
                    return;
                }
                
                playlistEl.innerHTML = '';
                tracks.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = `playlist-item ${this.currentTrack && this.currentTrack.id === item.id ? 'playing' : ''}`;
                    li.innerHTML = `
                        <span class="playlist-item-title">${item.title} - ${item.artist}</span>
                        <span class="playlist-item-duration">${this.formatTime(item.duration)}</span>
                    `;
                    
                    li.addEventListener('click', () => {
                        this.playTrack(item);
                    });
                    
                    playlistEl.appendChild(li);
                });
            }
            
            // æ‰§è¡Œæœç´¢
            async performSearch() {
                const query = document.getElementById('searchInput').value.trim();
                if (!query) return;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const resultsEl = document.getElementById('searchResults');
                resultsEl.innerHTML = '<li class="loading">æœç´¢ä¸­...</li>';
                
                try {
                    // ä½¿ç”¨å½“å‰é€‰æ‹©çš„éŸ³æºè¿›è¡Œæœç´¢
                    const selectedSource = this.currentSource;
                    console.log(`ä½¿ç”¨éŸ³æº ${selectedSource} æœç´¢: ${query}`);
                    
                    // è°ƒç”¨éŸ³æºç®¡ç†å™¨çš„æœç´¢åŠŸèƒ½
                    const searchResults = await this.sourceManager.searchMusic(query, selectedSource);
                    
                    if (searchResults.length > 0) {
                        this.renderSearchResults(searchResults);
                    } else {
                        resultsEl.innerHTML = '<li class="loading">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</li>';
                    }
                } catch (error) {
                    console.error('æœç´¢å¤±è´¥:', error);
                    resultsEl.innerHTML = '<li class="loading">æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</li>';
                }
            }
            
            // æ¸²æŸ“æœç´¢ç»“æœ
            renderSearchResults(results) {
                const resultsEl = document.getElementById('searchResults');
                resultsEl.innerHTML = '';
                
                results.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'result-item';
                    li.innerHTML = `
                        <span class="result-item-title">${item.title} - ${item.artist}</span>
                        <span class="result-item-source">${item.source}</span>
                    `;
                    
                    li.addEventListener('click', async () => {
                        // æ·»åŠ åˆ°å½“å‰æ’­æ”¾åˆ—è¡¨
                        if (!this.playlists.current.some(track => track.id === item.id)) {
                            this.playlists.current.push(item);
                            this.renderPlaylist();
                        }
                        // æ’­æ”¾è¿™é¦–æ­Œ
                        await this.playTrack(item);
                    });
                    
                    resultsEl.appendChild(li);
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ’­æ”¾å™¨
        document.addEventListener('DOMContentLoaded', () => {
            const player = new MusicPlayer();
            
            // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰«æéŸ³æº
            setTimeout(() => {
                player.scanAndRenderSources();
            }, 1000);
        });
    </script>
</body>
</html>